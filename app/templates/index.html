<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG AI Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Background Elements -->
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                <h1>RAG AI Assistant</h1>
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Checking...</span>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">Total Videos</span>
                <span class="stat-value" id="totalVideos">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Chunks</span>
                <span class="stat-value" id="totalChunks">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ollama Status</span>
                <span class="stat-value" id="ollamaStatus">-</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Query Section -->
            <div class="query-section">
                <div class="input-wrapper">
                    <textarea 
                        id="queryInput" 
                        placeholder="Ask me anything about your videos... (e.g., How can AI help with YouTube content?)"
                        rows="3"
                    ></textarea>
                    <button id="submitBtn" class="btn-primary">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        Ask Question
                    </button>
                </div>
                
                <!-- Example Questions -->
                <div class="example-questions">
                    <span class="example-label">Try asking:</span>
                    <button class="example-btn" data-query="How can AI help with YouTube content creation?">
                        How can AI help with YouTube?
                    </button>
                    <button class="example-btn" data-query="What tools are discussed in the videos?">
                        What tools are discussed?
                    </button>
                    <button class="example-btn" data-query="How to make money using AI?">
                        How to make money with AI?
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <p>Analyzing your question...</p>
            </div>

            <!-- Response Section -->
            <div class="response-section" id="responseSection" style="display: none;">
                <!-- AI Response -->
                <div class="response-card">
                    <div class="card-header">
                        <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <h3>AI Response</h3>
                    </div>
                    <div class="card-content">
                        <div id="aiResponse" class="ai-response"></div>
                    </div>
                </div>

                <!-- Relevant Video Chunks -->
                <div class="response-card">
                    <div class="card-header">
                        <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                        <h3>Relevant Video Segments</h3>
                    </div>
                    <div class="card-content">
                        <div id="videoChunks" class="video-chunks"></div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage" style="display: none;">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <p id="errorText"></p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Powered by OpenAI Whisper, BGE-M3, and Llama 3.2 via Ollama</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // Global state
        let isProcessing = false;

        // DOM Elements
        const queryInput = document.getElementById('queryInput');
        const submitBtn = document.getElementById('submitBtn');
        const loadingState = document.getElementById('loadingState');
        const responseSection = document.getElementById('responseSection');
        const errorMessage = document.getElementById('errorMessage');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Check server health on load
        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDot.className = 'status-dot status-online';
                    statusText.textContent = 'Online';
                    loadStats();
                } else {
                    statusDot.className = 'status-dot status-warning';
                    statusText.textContent = 'Degraded';
                }
            } catch (error) {
                statusDot.className = 'status-dot status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('totalVideos').textContent = data.total_videos;
                document.getElementById('totalChunks').textContent = data.total_chunks;
                
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                document.getElementById('ollamaStatus').textContent = 
                    healthData.ollama_status === 'online' ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline';
                
                document.getElementById('statsBar').style.display = 'flex';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Submit query
        async function submitQuery() {
            if (isProcessing) return;
            
            const query = queryInput.value.trim();
            if (!query) {
                showError('Please enter a question.');
                return;
            }

            // Reset UI
            isProcessing = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            loadingState.style.display = 'flex';
            responseSection.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                if (data.success) {
                    displayResponse(data);
                } else {
                    showError(data.error || 'An error occurred processing your query.');
                }
            } catch (error) {
                showError('Failed to connect to server. Please make sure the server is running.');
            } finally {
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    Ask Question
                `;
                loadingState.style.display = 'none';
            }
        }

        // Display response
        function displayResponse(data) {
            // Display AI response
            const aiResponse = document.getElementById('aiResponse');
            aiResponse.innerHTML = formatResponse(data.response);

            // Display video chunks
            const videoChunks = document.getElementById('videoChunks');
            videoChunks.innerHTML = data.chunks.map(chunk => {
                return `
                    <div class="chunk-item">
                        <div class="chunk-header">
                            <span class="chunk-video">Video ${chunk.video_num}</span>
                            <span class="chunk-time">${chunk.start} - ${chunk.end}</span>
                            <span class="chunk-similarity">${(chunk.similarity * 100).toFixed(1)}% match</span>
                        </div>
                        <div class="chunk-title">${escapeHtml(chunk.title)}</div>
                        <div class="chunk-text">${escapeHtml(chunk.text)}</div>
                        ${chunk.has_youtube ? `
                            <a href="${chunk.youtube_url}" class="chunk-link" target="_blank" rel="noopener noreferrer">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                </svg>
                                Watch on YouTube at ${chunk.start}
                            </a>
                        ` : ''}
                    </div>
                `;
            }).join('');

            responseSection.style.display = 'block';
            
            // Smooth scroll to response
            responseSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Format response text with line breaks
        function formatResponse(text) {
            return text
                .split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(line => `<p>${escapeHtml(line)}</p>`)
                .join('');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            errorMessage.style.display = 'flex';
            responseSection.style.display = 'none';
        }

        // Event Listeners
        submitBtn.addEventListener('click', submitQuery);

        queryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                submitQuery();
            }
        });

        // Example questions
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                queryInput.value = btn.getAttribute('data-query');
                queryInput.focus();
            });
        });

        // Initialize
        checkHealth();
    </script>
</body>
</html>

